// ============================================================================
// Hybrid Web3 SocialFi & Ad-Tech DApp — Prisma Schema
// ============================================================================
// Database: PostgreSQL
// ORM:      Prisma
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  USER
  MERCHANT
  ADMIN
}

enum AuthProvider {
  EMAIL        // Web2: email + password
  WALLET       // Web3: wallet signature (SIWE)
  GOOGLE       // OAuth (future)
}

enum PostType {
  ORGANIC      // Regular user post
  SPONSORED    // Injected via AdCampaign
}

enum MediaType {
  IMAGE
  VIDEO
  GIF
  NONE
}

enum InteractionType {
  LIKE
  COMMENT
  SHARE
  VIEW         // Tracked for ad impressions
  BOOKMARK
}

enum PaymentMethod {
  FIAT_STRIPE
  CRYPTO_USDT
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum CampaignStatus {
  DRAFT
  PENDING_PAYMENT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum RewardType {
  AD_VIEW           // User viewed a sponsored post
  AD_ENGAGEMENT     // User liked/commented/shared a sponsored post
  REFERRAL_BONUS    // 5% cut from referred user's earnings
  WITHDRAWAL        // User withdrew tokens (negative)
  AIRDROP           // Manual or promotional distribution
  SIGNUP_BONUS      // One-time signup reward
}

enum RewardStatus {
  PENDING           // Credited off-chain, not yet distributed
  CONFIRMED         // Verified and ready for batch distribution
  DISTRIBUTED       // On-chain tx completed
  FAILED            // Distribution attempt failed
}

enum BatchStatus {
  PENDING
  PROCESSING
  CONFIRMED
  FAILED
}

enum NftRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum ListingStatus {
  ACTIVE
  SOLD
  CANCELLED
}

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  INCOMPLETE
}

enum ServiceType {
  BOOST_POST
  PREMIUM_BADGE
  ANALYTICS_PRO
  VERIFIED_BADGE
  EXTRA_STORAGE
}

enum ServicePurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum NotificationType {
  FOLLOW           // Someone followed you
  LIKE             // Someone liked your post
  COMMENT          // Someone commented on your post
  REWARD_EARNED    // You earned a reward
  WITHDRAWAL_DONE  // Your withdrawal was processed
  AIRDROP          // Admin airdropped tokens to you
  SYSTEM           // General system message
}

// ============================================================================
// USER — Web2/Web3 Auth + Referral Tracking
// ============================================================================

model User {
  id              String    @id @default(uuid())
  
  // --- Authentication ---
  email           String?   @unique          // Web2 login (nullable for wallet-only users)
  passwordHash    String?                     // bcrypt hash (nullable for wallet-only users)
  authProvider    AuthProvider @default(EMAIL)
  
  // --- Web3 ---
  walletAddress   String?   @unique          // Ethereum/Polygon wallet address
  nonce           String?                     // Random nonce for SIWE signature verification
  
  // --- Profile ---
  username        String    @unique
  displayName     String?
  avatarUrl       String?
  bio             String?
  role            UserRole  @default(USER)
  isVerified      Boolean   @default(false)
  
  // --- Referral / Affiliate System ---
  referralCode    String    @unique          // Auto-generated unique code
  referredBy      User?     @relation("Referrals", fields: [referredById], references: [id])
  referredById    String?
  referrals       User[]    @relation("Referrals") // Users this person referred
  
  // --- Demographics / Targeting ---
  interests       String[]  @default([])
  location        String?
  birthYear       Int?
  gender          String?

  // --- Subscription ---
  subscriptionTier SubscriptionTier @default(FREE)

  // --- Off-chain Token Balance ---
  offChainBalance Decimal   @default(0) @db.Decimal(20, 8) // Accumulated but undistributed tokens
  totalEarned     Decimal   @default(0) @db.Decimal(20, 8) // Lifetime earnings
  totalWithdrawn  Decimal   @default(0) @db.Decimal(20, 8) // Lifetime withdrawals
  
  // --- Email Verification ---
  emailVerified         Boolean   @default(false)
  emailVerifyToken      String?   @unique
  emailVerifyExpiresAt  DateTime?

  // --- Password Reset ---
  passwordResetToken    String?   @unique
  passwordResetExpiresAt DateTime?

  // --- Timestamps ---
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime?

  // --- Relations ---
  posts           SocialPost[]
  interactions    PostInteraction[]
  adCampaigns     AdCampaign[]        // Campaigns created (merchants only)
  rewards         RewardTransaction[] @relation("UserRewards")
  referralRewards RewardTransaction[] @relation("ReferralSource") // Rewards generated from this user's activity for their referrer
  followers       Follow[]            @relation("Following")      // Users who follow this user
  following       Follow[]            @relation("Followers")      // Users this user follows
  notifications   Notification[]
  subscriptions   Subscription[]
  servicePurchases ServicePurchase[]
  nfts            Nft[]           @relation("NftOwner")
  mintedNfts      Nft[]           @relation("NftMinter")
  listings        NftListing[]    @relation("ListingSeller")
  purchases       NftListing[]    @relation("ListingBuyer")

  @@index([walletAddress])
  @@index([referralCode])
  @@index([referredById])
  @@map("users")
}

// ============================================================================
// SOCIAL POST — Organic + Sponsored
// ============================================================================

model SocialPost {
  id              String    @id @default(uuid())
  
  // --- Author ---
  author          User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId        String
  
  // --- Content ---
  content         String    @db.Text         // Post text body
  mediaUrl        String?                     // Image/video URL
  mediaType       MediaType @default(NONE)
  
  // --- Post Classification ---
  type            PostType  @default(ORGANIC)
  
  // --- Sponsored Post Link ---
  adCampaign      AdCampaign? @relation(fields: [adCampaignId], references: [id], onDelete: SetNull)
  adCampaignId    String?
  
  // --- Denormalized Counters (for fast feed queries) ---
  likesCount      Int       @default(0)
  commentsCount   Int       @default(0)
  sharesCount     Int       @default(0)
  viewsCount      Int       @default(0)
  bookmarksCount  Int       @default(0)
  
  // --- Reward Config (for sponsored posts) ---
  rewardPerView       Decimal? @db.Decimal(20, 8) // Tokens earned per view
  rewardPerEngagement Decimal? @db.Decimal(20, 8) // Tokens earned per like/comment/share
  
  // --- State ---
  isActive        Boolean   @default(true)
  isPinned        Boolean   @default(false)
  
  // --- Timestamps ---
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // --- Relations ---
  interactions    PostInteraction[]
  rewards         RewardTransaction[]

  @@index([authorId])
  @@index([type])
  @@index([adCampaignId])
  @@index([createdAt(sort: Desc)])
  @@map("social_posts")
}

// ============================================================================
// POST INTERACTION — Likes, Comments, Shares, Views, Bookmarks
// ============================================================================

model PostInteraction {
  id              String          @id @default(uuid())
  
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  
  post            SocialPost      @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId          String
  
  type            InteractionType
  
  // --- Comment-specific ---
  commentText     String?   @db.Text
  
  // --- Timestamps ---
  createdAt       DateTime  @default(now())

  // Prevent duplicate likes/bookmarks per user per post
  @@unique([userId, postId, type], name: "unique_user_post_interaction")
  @@index([postId, type])
  @@map("post_interactions")
}

// ============================================================================
// FOLLOW — Social Graph
// ============================================================================

model Follow {
  id              String    @id @default(uuid())
  
  follower        User      @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  followerId      String
  
  following       User      @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  followingId     String
  
  createdAt       DateTime  @default(now())

  @@unique([followerId, followingId])
  @@map("follows")
}

// ============================================================================
// AD PACKAGE — Predefined Tiers Merchants Can Purchase
// ============================================================================

model AdPackage {
  id              String    @id @default(uuid())
  
  name            String                     // e.g. "Starter", "Growth", "Enterprise"
  description     String?   @db.Text
  
  // --- Pricing ---
  priceFiat       Decimal   @db.Decimal(10, 2)  // Price in USD
  priceCrypto     Decimal   @db.Decimal(20, 8)  // Price in USDT
  
  // --- Deliverables ---
  impressions     Int                          // Guaranteed impressions
  durationDays    Int                          // Campaign duration in days
  maxPosts        Int       @default(1)        // Number of sponsored posts allowed
  
  // --- Reward Pool ---
  totalRewardPool Decimal   @db.Decimal(20, 8)  // Tokens allocated for user rewards
  
  // --- State ---
  isActive        Boolean   @default(true)
  sortOrder       Int       @default(0)
  
  // --- Timestamps ---
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // --- Relations ---
  campaigns       AdCampaign[]

  @@map("ad_packages")
}

// ============================================================================
// AD CAMPAIGN — Merchant's Active Campaign (Stripe / USDT Payment Tracking)
// ============================================================================

model AdCampaign {
  id              String         @id @default(uuid())
  
  // --- Merchant ---
  merchant        User           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  merchantId      String
  
  // --- Package ---
  adPackage       AdPackage      @relation(fields: [adPackageId], references: [id])
  adPackageId     String
  
  // --- Campaign Content ---
  title           String
  description     String?        @db.Text
  targetUrl       String?                     // External link (product page, mint page)
  
  // --- Payment ---
  paymentMethod   PaymentMethod
  paymentStatus   PaymentStatus  @default(PENDING)
  amountPaid      Decimal        @db.Decimal(20, 8) @default(0)
  
  // Fiat (Stripe)
  stripeSessionId   String?      @unique      // Stripe Checkout Session ID
  stripePaymentId   String?      @unique      // Stripe Payment Intent ID
  
  // Crypto (USDT)
  cryptoTxHash      String?      @unique      // On-chain deposit transaction hash
  cryptoFromAddress String?                    // Depositor wallet address
  
  // --- Audience Targeting ---
  targetInterests   String[]  @default([])
  targetLocation    String?
  targetAgeMin      Int?
  targetAgeMax      Int?
  targetGender      String?

  // --- Delivery Tracking ---
  impressionsTotal     Int       @default(0)  // From AdPackage
  impressionsDelivered Int       @default(0)  // Actual views served
  clickCount           Int       @default(0)  // Link clicks for CTR
  
  // --- Reward Pool ---
  rewardPoolTotal      Decimal   @db.Decimal(20, 8) @default(0) // Total tokens for rewards
  rewardPoolDistributed Decimal  @db.Decimal(20, 8) @default(0) // Tokens already distributed
  
  // --- Campaign State ---
  status          CampaignStatus @default(DRAFT)
  startsAt        DateTime?
  endsAt          DateTime?
  
  // --- Timestamps ---
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // --- Relations ---
  posts           SocialPost[]
  rewards         RewardTransaction[]

  @@index([merchantId])
  @@index([status])
  @@index([paymentStatus])
  @@map("ad_campaigns")
}

// ============================================================================
// SUBSCRIPTION — Stripe Recurring Billing
// ============================================================================

model Subscription {
  id                    String             @id @default(uuid())

  // --- User ---
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String

  // --- Tier ---
  tier                  SubscriptionTier

  // --- Stripe ---
  stripeCustomerId      String?
  stripeSubscriptionId  String?            @unique
  stripePriceId         String?

  // --- Billing Period ---
  status                SubscriptionStatus @default(ACTIVE)
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean            @default(false)

  // --- Timestamps ---
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}

// ============================================================================
// PAID SERVICE — One-time purchasable features
// ============================================================================

model PaidService {
  id              String      @id @default(uuid())

  name            String                  // e.g. "Boost Post", "Premium Badge"
  description     String?     @db.Text
  type            ServiceType @unique
  priceUsd        Decimal     @db.Decimal(10, 2)
  stripePriceId   String?                 // Stripe Price ID for one-time payment
  isActive        Boolean     @default(true)
  durationDays    Int?                    // null = permanent, otherwise temporary
  sortOrder       Int         @default(0)

  // --- Timestamps ---
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // --- Relations ---
  purchases       ServicePurchase[]

  @@map("paid_services")
}

// ============================================================================
// SERVICE PURCHASE — User's one-time service purchases
// ============================================================================

model ServicePurchase {
  id                  String                @id @default(uuid())

  // --- User ---
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String

  // --- Service ---
  service             PaidService           @relation(fields: [serviceId], references: [id])
  serviceId           String

  // --- Payment ---
  stripePaymentId     String?               @unique
  stripeSessionId     String?               @unique
  status              ServicePurchaseStatus @default(PENDING)
  amountPaid          Decimal               @db.Decimal(10, 2) @default(0)

  // --- Context ---
  metadata            Json?                 // e.g. { postId } for BOOST_POST
  expiresAt           DateTime?             // null = permanent

  // --- Timestamps ---
  createdAt           DateTime              @default(now())

  @@index([userId])
  @@index([serviceId])
  @@index([status])
  @@map("service_purchases")
}

// ============================================================================
// REWARD TRANSACTION — Off-Chain Ledger (the core Engage-to-Earn record)
// ============================================================================

model RewardTransaction {
  id              String        @id @default(uuid())
  
  // --- Recipient ---
  user            User          @relation("UserRewards", fields: [userId], references: [id], onDelete: Cascade)
  userId          String
  
  // --- Reward Details ---
  type            RewardType
  amount          Decimal       @db.Decimal(20, 8) // Positive = earned, Negative = withdrawn
  description     String?
  
  // --- Source References ---
  relatedPost     SocialPost?   @relation(fields: [relatedPostId], references: [id], onDelete: SetNull)
  relatedPostId   String?
  
  relatedCampaign AdCampaign?   @relation(fields: [relatedCampaignId], references: [id], onDelete: SetNull)
  relatedCampaignId String?
  
  // --- Referral Tracking ---
  // If type == REFERRAL_BONUS, this points to the referred user whose action triggered the bonus
  sourceUser      User?         @relation("ReferralSource", fields: [sourceUserId], references: [id], onDelete: SetNull)
  sourceUserId    String?
  referralRate    Decimal?      @db.Decimal(5, 4) // e.g. 0.0500 = 5%
  
  // --- Distribution Status ---
  status          RewardStatus  @default(PENDING)
  
  // --- On-chain Settlement ---
  distributionBatch   DistributionBatch? @relation(fields: [distributionBatchId], references: [id])
  distributionBatchId String?
  onChainTxHash       String?            // Individual tx hash (if not batched)
  
  // --- Timestamps ---
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, type])
  @@index([userId, status])
  @@index([relatedCampaignId])
  @@index([distributionBatchId])
  @@index([createdAt(sort: Desc)])
  @@map("reward_transactions")
}

// ============================================================================
// DISTRIBUTION BATCH — On-Chain Batch Payouts via Escrow Contract
// ============================================================================

model DistributionBatch {
  id              String      @id @default(uuid())
  
  // --- On-chain Details ---
  txHash          String?     @unique        // Smart contract transaction hash
  contractAddress String?                     // Escrow contract address used
  chainId         Int?                        // Network chain ID (e.g. 137 for Polygon)
  
  // --- Batch Summary ---
  totalAmount     Decimal     @db.Decimal(20, 8)
  recipientCount  Int
  
  // --- State ---
  status          BatchStatus @default(PENDING)
  errorMessage    String?     @db.Text
  
  // --- Timestamps ---
  createdAt       DateTime    @default(now())
  processedAt     DateTime?
  confirmedAt     DateTime?

  // --- Relations ---
  rewards         RewardTransaction[]

  @@index([status])
  @@map("distribution_batches")
}

// ============================================================================
// NOTIFICATION — In-app + SSE real-time notifications
// ============================================================================

model Notification {
  id              String           @id @default(uuid())

  // --- Recipient ---
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String

  // --- Content ---
  type            NotificationType
  title           String
  message         String           @db.Text
  isRead          Boolean          @default(false)

  // --- Optional context links ---
  relatedPostId   String?
  relatedUserId   String?          // e.g. who followed you
  relatedTxId     String?          // reward/withdrawal tx

  // --- Timestamps ---
  createdAt       DateTime         @default(now())

  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}

// ============================================================================
// NFT — Off-chain metadata record (on-chain tokenId stored when minted)
// ============================================================================

model Nft {
  id              String      @id @default(uuid())

  // --- Ownership ---
  owner           User        @relation("NftOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId         String
  minter          User        @relation("NftMinter", fields: [minterId], references: [id])
  minterId        String

  // --- Metadata ---
  name            String
  description     String?     @db.Text
  imageUrl        String
  collection      String      @default("SocialFi Genesis")
  rarity          NftRarity   @default(COMMON)
  attributes      Json?       // [{ trait_type, value }]

  // --- On-chain ---
  tokenId         String?     @unique   // ERC-721 token ID once minted on-chain
  contractAddress String?
  chainId         Int?

  // --- Timestamps ---
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // --- Relations ---
  listings        NftListing[]

  @@index([ownerId])
  @@index([minterId])
  @@index([rarity])
  @@index([collection])
  @@map("nfts")
}

// ============================================================================
// NFT LISTING — Marketplace listing for an NFT
// ============================================================================

model NftListing {
  id              String        @id @default(uuid())

  // --- NFT ---
  nft             Nft           @relation(fields: [nftId], references: [id], onDelete: Cascade)
  nftId           String

  // --- Seller ---
  seller          User          @relation("ListingSeller", fields: [sellerId], references: [id])
  sellerId        String

  // --- Buyer (set on sale) ---
  buyer           User?         @relation("ListingBuyer", fields: [buyerId], references: [id])
  buyerId         String?

  // --- Pricing (SFT tokens) ---
  price           Decimal       @db.Decimal(20, 8)  // Price in SFT tokens
  status          ListingStatus @default(ACTIVE)

  // --- Timestamps ---
  listedAt        DateTime      @default(now())
  soldAt          DateTime?

  @@index([nftId])
  @@index([sellerId])
  @@index([status])
  @@index([price])
  @@map("nft_listings")
}
